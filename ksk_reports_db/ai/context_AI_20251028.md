
# –ò–° –ö–°–ö - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è AI

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 28 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 2.1
**–°—Ç–∞—Ç—É—Å:** Production Ready

***

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û –ø—Ä–æ–µ–∫—Ç–µ](#%D0%BE-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B5)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D0%B1%D0%B0%D0%B7%D1%8B-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
4. [–°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏](#%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D0%BE%D1%82%D1%87%D1%91%D1%82%D0%BD%D0%BE%D1%81%D1%82%D0%B8)
5. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3)
6. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8)
7. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D1%81%D1%82%D0%B5%D0%BA)
8. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã](#%D0%BA%D1%80%D0%B8%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B)

***

## –û –ø—Ä–æ–µ–∫—Ç–µ

**–ò–° –ö–°–ö (–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤)** - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§ –ø–æ –ü–û–î/–§–¢ (–ø—Ä–æ—Ç–∏–≤–æ–¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º—ã–≤–∞–Ω–∏—é –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—é —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º–∞).

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–∞–º
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –°–§–ú (–°–ª—É–∂–±–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞) –∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–≤
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¶–ë –†–§ –∏ 115-–§–ó


### –ë–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

- –û–±—Ä–∞–±–æ—Ç–∫–∞: **~3 –º–∏–ª–ª–∏–æ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –¥–µ–Ω—å**
- –û–±—ä—ë–º –ë–î: **~3 TB** (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- Retention: **365 –¥–Ω–µ–π** –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, **30 –¥–Ω–µ–π** –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤
- SLA: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å **99.5%**, RTO **4 —á–∞—Å–∞**, RPO **5 –º–∏–Ω—É—Ç**

***

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Banking Core       ‚îÇ
‚îÇ  (Source System)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Apache Kafka                    ‚îÇ
‚îÇ  - upoa_enriched_transactions    ‚îÇ  <- –í—Ö–æ–¥—è—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚îÇ  - upoa_ksk_results              ‚îÇ  <- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  KSK Consumer (Java/Spring Boot) ‚îÇ
‚îÇ  - Join by corrId                ‚îÇ  <- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ  - Business Logic                ‚îÇ  <- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
‚îÇ  - Micrometer Metrics            ‚îÇ  <- –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Prometheus
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL 14+ Database         ‚îÇ
‚îÇ  Schema: upoa_ksk_reports        ‚îÇ
‚îÇ  - ksk_result (partitioned)      ‚îÇ  <- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (3TB)
‚îÇ  - ksk_figurant (partitioned)    ‚îÇ  <- –§–∏–≥—É—Ä–∞–Ω—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–æ–≤
‚îÇ  - ksk_figurant_match (part.)    ‚îÇ  <- –î–µ—Ç–∞–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
‚îÇ  - ksk_report_* (6 tables)       ‚îÇ  <- –°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏
‚îÇ  - ksk_system_operation_log      ‚îÇ  <- –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Reporting Module                ‚îÇ
‚îÇ  - ksk_report_orchestrator       ‚îÇ  <- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞–º–∏
‚îÇ  - 5 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤      ‚îÇ  <- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00
‚îÇ  - TTL-based cleanup             ‚îÇ  <- –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Web UI (Browser)                ‚îÇ
‚îÇ  - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–æ–≤              ‚îÇ
‚îÇ  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É          ‚îÇ
‚îÇ  - –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel/CSV           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Monitoring Stack                ‚îÇ
‚îÇ  - Prometheus (–º–µ—Ç—Ä–∏–∫–∏)          ‚îÇ
‚îÇ  - Grafana (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)        ‚îÇ
‚îÇ  - Kafka Exporter                ‚îÇ
‚îÇ  - PostgreSQL Exporter           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞: `upoa_ksk_reports`

#### 1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ)

**ksk_result** - –≥–ª–∞–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **RANGE –ø–æ output_timestamp (daily)**
- –û–±—ä—ë–º: ~3 TB, ~3M –∑–∞–ø–∏—Å–µ–π/–¥–µ–Ω—å
- Retention: 365 –¥–Ω–µ–π
- JSONB –ø–æ–ª—è: input_json, output_json (STORAGE EXTERNAL –Ω–∞ HDD)

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**

```sql
id INTEGER (auto-increment)
date DATE NOT NULL
corr_id VARCHAR(100) NOT NULL -- –¥–ª—è join —Å–æ–æ–±—â–µ–Ω–∏–π
input_timestamp TIMESTAMP
output_timestamp TIMESTAMP NOT NULL
payment_type VARCHAR(20) -- I, O, T, M, V
resolution VARCHAR(20) -- allow, review, deny, empty
list_codes TEXT[] -- –º–∞—Å—Å–∏–≤ –∫–æ–¥–æ–≤ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
has_bypass VARCHAR(10) -- empty, yes, no
-- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∏–∑ JSON
payment_id, payer_inn, payer_name, receiver_inn, receiver_name
amount, currency, ...
```

**ksk_figurant** - —Ñ–∏–≥—É—Ä–∞–Ω—Ç—ã –∏–∑ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤

- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **RANGE –ø–æ timestamp (daily)**
- –°–≤—è–∑—å: source_id ‚Üí ksk_result.id (1:N)

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**

```sql
id INTEGER (auto-increment)
timestamp TIMESTAMP NOT NULL
source_id INTEGER -- FK to ksk_result.id
list_code VARCHAR(10) -- 4200, 4204, 4205, ...
name_figurant TEXT
president_group TEXT
auto_login TEXT
has_exclusion TEXT
exclusion_phrase TEXT
is_bypass TEXT
```

**ksk_figurant_match** - –¥–µ—Ç–∞–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **RANGE –ø–æ timestamp (daily)**
- –°–≤—è–∑—å: figurant_id ‚Üí ksk_figurant.id (1:N)

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**

```sql
id INTEGER (auto-increment)
timestamp TIMESTAMP NOT NULL
figurant_id INTEGER -- FK to ksk_figurant.id
algorithm VARCHAR(50)
match_value TEXT
match_payment_field TEXT
match_payment_value TEXT
```


#### 2. –°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ (7 —Ç–∞–±–ª–∏—Ü)

**ksk_report_orchestrator** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–æ–≤

```sql
id INTEGER PRIMARY KEY
report_code VARCHAR(50) UNIQUE -- totals, figurants, etc.
report_table VARCHAR(100) -- –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
report_function VARCHAR(100) -- —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
name VARCHAR(200) -- –æ–ø–∏—Å–∞–Ω–∏–µ
system_ttl INTEGER DEFAULT 30 -- TTL –¥–ª—è system-–æ—Ç—á—ë—Ç–æ–≤ (–¥–Ω–∏)
user_ttl INTEGER DEFAULT 7 -- TTL –¥–ª—è user-–æ—Ç—á—ë—Ç–æ–≤ (–¥–Ω–∏)
```

**–¢–∏–ø—ã –æ—Ç—á—ë—Ç–æ–≤:**

1. **totals** - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (365/14 –¥–Ω–µ–π)
2. **totals_by_payment_type** - –ø–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π (365/14)
3. **list_totals** - –ø–æ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–∞–º (365/14)
4. **list_totals_by_payment_type** - —Å–ø–∏—Å–æ–∫√ó—Ç–∏–ø (365/14)
5. **figurants** - –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ (30/7)
6. **review** - –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç (30 –¥–Ω–µ–π)

**ksk_report_header** - –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—á—ë—Ç–æ–≤

```sql
id INTEGER PRIMARY KEY
report_code VARCHAR(50) -- FK to orchestrator
initiator VARCHAR(20) -- 'system' –∏–ª–∏ 'user'
user_login VARCHAR(100) -- –¥–ª—è user-–æ—Ç—á—ë—Ç–æ–≤
start_date DATE
end_date DATE
parameters JSONB -- –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ñ–∏–ª—å—Ç—Ä—ã)
status VARCHAR(20) -- created, in_progress, done, error
created_at TIMESTAMP
completed_at TIMESTAMP
error_message TEXT
```

**ksk_report_*_data** - 5 —Ç–∞–±–ª–∏—Ü –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤

- ksk_report_totals_data
- ksk_report_totals_by_payment_type_data
- ksk_report_list_totals_data
- ksk_report_list_totals_by_payment_type_data
- ksk_report_figurants_data


#### 3. –°–ª—É–∂–µ–±–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

**ksk_system_operation_log** - –∞—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π

```sql
id BIGINT PRIMARY KEY
operation_code VARCHAR(50)
operation_name VARCHAR(200)
start_time TIMESTAMP
end_time TIMESTAMP
status VARCHAR(20) -- success, error
info JSONB
error_message TEXT
```

**–û–ø–µ—Ä–∞—Ü–∏–∏:**

- create_partitions_all
- drop_old_partitions
- cleanup_empty_records
- cleanup_empty_partitions
- generate_report_* (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞)
- cleanup_old_reports

***

## –°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã (pg_cron, –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00)

```sql
-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 4 –æ—Ç—á—ë—Ç–æ–≤ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å
SELECT ksk_run_report('totals', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('totals_by_payment_type', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('list_totals', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('list_totals_by_payment_type', 'system', NULL, CURRENT_DATE - 1);
```


### –†—É—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤

```sql
-- –û—Ç—á—ë—Ç –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
SELECT ksk_run_report(
  'figurants',
  'user',
  'ivanov',
  '2025-10-01',
  '2025-10-31',
  '{"list_codes": ["4200", "4204"]}'::jsonb
);
```


### TTL –∏ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ (pg_cron, –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 05:00)

```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ—Ç—á—ë—Ç–æ–≤
SELECT ksk_cleanup_old_reports();
```

–õ–æ–≥–∏–∫–∞:

- **System-–æ—Ç—á—ë—Ç—ã**: —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `system_ttl` –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- **User-–æ—Ç—á—ë—Ç—ã**: —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `user_ttl` –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è

***

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 27 –º–µ—Ç—Ä–∏–∫ –≤ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö

#### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 1: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (5 –º–µ—Ç—Ä–∏–∫)

1. PostgreSQL connections (<300 –Ω–æ—Ä–º–∞, >400 –∫—Ä–∏—Ç–∏—á–Ω–æ)
2. Database size (—Ä–æ—Å—Ç ~100 GB/–º–µ—Å—è—Ü)
3. Kafka consumer group members (1 –Ω–æ—Ä–º–∞, 0 –∫—Ä–∏—Ç–∏—á–Ω–æ)
4. Kafka topics availability
5. KSK Consumer Service health

#### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 2: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (12 –º–µ—Ç—Ä–∏–∫)

1. PostgreSQL TPS (30-50 –Ω–æ—Ä–º–∞, <10 –∏–ª–∏ >1000 –∫—Ä–∏—Ç–∏—á–Ω–æ)
2. Cache Hit Ratio (>99% –Ω–æ—Ä–º–∞, <95% –∫—Ä–∏—Ç–∏—á–Ω–æ)
3. Table Bloat % (0-10% –Ω–æ—Ä–º–∞, >30% –∫—Ä–∏—Ç–∏—á–Ω–æ)
4. Index Usage % (>90% –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ, <50% –∫—Ä–∏—Ç–∏—á–Ω–æ)
5. Kafka Consumer Lag (<100K –Ω–æ—Ä–º–∞, >200K –∫—Ä–∏—Ç–∏—á–Ω–æ)
6. Kafka Messages Rate (<1300 msg/sec –Ω–æ—Ä–º–∞, >1500 –∫—Ä–∏—Ç–∏—á–Ω–æ)
7. PostgreSQL Locks (0-5 –Ω–æ—Ä–º–∞, >50 –ø—Ä–æ–≤–µ—Ä–∫–∞)
8. Checkpoints ratio
9. Database Age (<1B –Ω–æ—Ä–º–∞, >1.5B –∫—Ä–∏—Ç–∏—á–Ω–æ)
10. Temporary files usage
11. Deadlocks (>0 –∫—Ä–∏—Ç–∏—á–Ω–æ)
12. Autovacuum activity

#### –ö–∞—Ç–µ–≥–æ—Ä–∏—è 3: –ü—Ä–∏–∫–ª–∞–¥–Ω–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (10 –º–µ—Ç—Ä–∏–∫)

1. Consumer processing rate (30-50 msg/sec –Ω–æ—Ä–º–∞)
2. Join success rate (>98% –Ω–æ—Ä–º–∞, <95% –∫—Ä–∏—Ç–∏—á–Ω–æ)
3. Join delay p95 (<2 sec –Ω–æ—Ä–º–∞, >10 sec –∫—Ä–∏—Ç–∏—á–Ω–æ)
4. DB write duration p95 (<100ms –Ω–æ—Ä–º–∞, >200ms –∫—Ä–∏—Ç–∏—á–Ω–æ)
5. DB write errors (<1% –∫—Ä–∏—Ç–∏—á–Ω–æ)
6. Orphan messages (0-10 –Ω–æ—Ä–º–∞, >100 –∫—Ä–∏—Ç–∏—á–Ω–æ)
7. Report generation success
8. Report generation time (Totals <5 –º–∏–Ω, Figurants <15 –º–∏–Ω)
9. pg_cron jobs success
10. Operation log errors

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

- **Prometheus** - —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- **Grafana** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (3 –≥–æ—Ç–æ–≤—ã—Ö dashboard)
- **Kafka Exporter** - –º–µ—Ç—Ä–∏–∫–∏ Kafka
- **postgres_exporter** - –º–µ—Ç—Ä–∏–∫–∏ PostgreSQL
- **Micrometer** (Java/Spring Boot) - –º–µ—Ç—Ä–∏–∫–∏ KSK Consumer

***

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### PostgreSQL –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 1. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

- **Daily partitions** –ø–æ timestamp/output_timestamp
- –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞ **7 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥** (pg_cron, 02:00)
- –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π **—Å—Ç–∞—Ä—à–µ 365 –¥–Ω–µ–π** (pg_cron, 04:00)

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
SELECT ksk_create_partitions_for_all_tables(CURRENT_DATE, 7);

-- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö
SELECT ksk_drop_old_partitions('ksk_result', 365);
```


#### 2. –ò–Ω–¥–µ–∫—Å—ã

```sql
-- ksk_result
CREATE INDEX idx_ksk_result_output_timestamp ON ksk_result(output_timestamp);
CREATE INDEX idx_ksk_result_corr_id ON ksk_result(corr_id);
CREATE INDEX idx_ksk_result_date ON ksk_result(date);
CREATE INDEX idx_ksk_result_resolution ON ksk_result(resolution);
CREATE INDEX idx_ksk_result_payment_type ON ksk_result(payment_type);

-- ksk_figurant
CREATE INDEX idx_ksk_figurant_source_id ON ksk_figurant(source_id);
CREATE INDEX idx_ksk_figurant_list_code ON ksk_figurant(list_code);

-- ksk_figurant_match
CREATE INDEX idx_ksk_figurant_match_figurant_id ON ksk_figurant_match(figurant_id);
```


#### 3. JSONB Storage

```sql
-- EXTERNAL storage –¥–ª—è JSONB (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ HDD –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏)
ALTER TABLE ksk_result ALTER COLUMN input_json SET STORAGE EXTERNAL;
ALTER TABLE ksk_result ALTER COLUMN output_json SET STORAGE EXTERNAL;
```


#### 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ JSONB –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è

- **–î–æ:** –ø–∞—Ä—Å–∏–Ω–≥ JSONB –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–º–µ–¥–ª–µ–Ω–Ω–æ)
- **–ü–æ—Å–ª–µ:** –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π –≤ TEXT –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** —É—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤ –≤ 5-10 —Ä–∞–∑

```sql
-- –ü—Ä–∏–º–µ—Ä –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –≤ put_ksk_result()
vpayment_info := pinputjson->'paymentInfo';
vpayer_inn := vpayment_info->>'payerInn';
vpayer_name := vpayment_info->>'payerName';
-- –≤—Å—Ç–∞–≤–∫–∞ –≤ TEXT –ø–æ–ª—è
```


#### 5. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—á—ë—Ç list_totals_by_payment_type –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è 110 —Å–µ–∫—É–Ω–¥ (LOOP –ø–æ –º–∞—Å—Å–∏–≤—É list_codes)

**–†–µ—à–µ–Ω–∏–µ:** UNNEST + COUNT(*) FILTER –≤–º–µ—Å—Ç–æ LOOP

```sql
-- –î–û (–º–µ–¥–ª–µ–Ω–Ω–æ):
FOR vlist_code IN SELECT unnest(list_codes) LOOP
  -- –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ SELECT COUNT(*)
END LOOP;

-- –ü–û–°–õ–ï (–±—ã—Å—Ç—Ä–æ):
INSERT INTO report_table
SELECT 
  list_code,
  COUNT(*) FILTER (WHERE payment_type = 'I') AS i_total,
  COUNT(*) FILTER (WHERE payment_type = 'O') AS o_total,
  ...
FROM ksk_result
CROSS JOIN UNNEST(list_codes) AS list_code
GROUP BY list_code;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 110 —Å–µ–∫ ‚Üí 10-20 —Å–µ–∫ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 5-10 —Ä–∞–∑)

#### 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

```sql
-- –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (resolution –ø—É—Å—Ç–æ–π)
SELECT ksk_cleanup_empty_records(14); -- —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π

-- –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
SELECT ksk_cleanup_empty_partitions('ksk_result', 7); -- —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
```


#### 7. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Bloat

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–∑–¥—É—Ç–∏—è —Ç–∞–±–ª–∏—Ü
SELECT * FROM ksk_monitor_table_bloat('upoa_ksk_reports');
```


***

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| Message Broker | Apache Kafka | 2.8+ | 2-3 –ø–∞—Ä—Ç–∏—Ü–∏–∏ |
| Consumer | Java + Spring Boot | 2.7+ / 3.x | Micrometer metrics |
| Database | PostgreSQL | 14+ | 3TB data, partitioned |
| Scheduler | pg_cron | 1.4+ | –ê–≤—Ç–æ–∑–∞–¥–∞—á–∏ |
| Monitoring | Prometheus | 2.x+ | –ú–µ—Ç—Ä–∏–∫–∏ |
| Visualization | Grafana | 8.x+ | Dashboards |
| Metrics | Micrometer | 1.9+ | Java metrics |
| Deployment | Kubernetes | 1.24+ | Container orchestration |

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**PostgreSQL Server:**

- CPU: 16+ cores
- RAM: 64 GB
- Disk: 5 TB SSD + HDD –¥–ª—è JSONB
- Network: 10 Gbit/s

**KSK Consumer:**

- CPU: 4 cores
- RAM: 8 GB
- Instances: 1-3 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏)

***

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### Kafka

- **Consumer Lag**: <100K –Ω–æ—Ä–º–∞, >200K –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Messages Rate**: <1300 msg/sec –Ω–æ—Ä–º–∞, >1500 –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Join Success Rate**: >98% –Ω–æ—Ä–º–∞, <95% –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Join Delay p95**: <2 sec –Ω–æ—Ä–º–∞, >10 sec –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Orphan Messages**: 0-10 –Ω–æ—Ä–º–∞, >100 –∫—Ä–∏—Ç–∏—á–Ω–æ


### PostgreSQL

- **Connections**: <300 –Ω–æ—Ä–º–∞, >400 –∫—Ä–∏—Ç–∏—á–Ω–æ
- **TPS**: 30-50 –Ω–æ—Ä–º–∞, <10 –∏–ª–∏ >1000 –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Cache Hit Ratio**: >99% –Ω–æ—Ä–º–∞, <95% –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Bloat %**: 0-10% –Ω–æ—Ä–º–∞, >30% –∫—Ä–∏—Ç–∏—á–Ω–æ (–Ω—É–∂–µ–Ω VACUUM)
- **Index Usage**: >90% –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ, <50% –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Database Age**: <1B –Ω–æ—Ä–º–∞, >1.5B –∫—Ä–∏—Ç–∏—á–Ω–æ (wraparound —Ä–∏—Å–∫)


### Application

- **Consumer Processing**: 30-50 msg/sec –Ω–æ—Ä–º–∞, <10 –∫—Ä–∏—Ç–∏—á–Ω–æ
- **DB Write Duration p95**: <100ms –Ω–æ—Ä–º–∞, >200ms –∫—Ä–∏—Ç–∏—á–Ω–æ
- **DB Write Errors**: 0% –Ω–æ—Ä–º–∞, >1% –∫—Ä–∏—Ç–∏—á–Ω–æ
- **Report Generation**: Totals <5 –º–∏–Ω, Figurants <15 –º–∏–Ω

***

## –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –¢–∏–ø—ã –ø–ª–∞—Ç–µ–∂–µ–π (payment_type)

- **I** - –í—Ö–æ–¥—è—â–∏–π
- **O** - –ò—Å—Ö–æ–¥—è—â–∏–π
- **T** - –¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–π
- **M** - –ú–µ–∂—Ñ–∏–ª–∏–∞–ª—å–Ω—ã–π
- **V** - –í–Ω—É—Ç—Ä–∏—Ñ–∏–ª–∏–∞–ª—å–Ω—ã–π

–í –æ—Ç—á—ë—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è** –¥–ª—è –ø–æ–ª–µ–π:

- `i_total` - –í—Ö–æ–¥—è—â–∏–π: –í—Å–µ–≥–æ
- `o_total` - –ò—Å—Ö–æ–¥—è—â–∏–π: –í—Å–µ–≥–æ
- –∏ —Ç.–¥.


### 2. –†–µ—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã (resolution)

- **allow** - —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- **review** - –Ω–∞ —Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –°–§–ú
- **deny** - –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- **empty** - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å (–ø–æ–¥–ª–µ–∂–∏—Ç —É–¥–∞–ª–µ–Ω–∏—é)


### 3. Bypass (has_bypass)

- **empty** - –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- **yes** - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)
- **no** - –Ω–µ bypass


### 4. corrId (Correlation ID)

–ö–ª—é—á –¥–ª—è join –¥–≤—É—Ö Kafka-—Å–æ–æ–±—â–µ–Ω–∏–π:

1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏–∑ `upoa_enriched_transactions`
2. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ `upoa_ksk_results`

Consumer –æ–∂–∏–¥–∞–µ—Ç –ø–∞—Ä—É –º–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ (p99)

### 5. –°–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (list_code)

–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–æ–≤:

- **4200** - –¶–ë –†–§: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º–æ–º
- **4204** - –¶–ë –†–§: –§–∏–∑–ª–∏—Ü–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º–æ–º
- **4205** - –¶–ë –†–§: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏—è–º–∏
- **4206** - –û–û–ù: –°–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
- **4207** - EU: –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Å–∞–Ω–∫—Ü–∏–∏
- **4208** - OFAC: –°–®–ê (SDN List)

***

## –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ PostgreSQL

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```sql
-- –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
SELECT put_ksk_result(
  p_input_timestamp, 
  p_output_timestamp, 
  p_input_json, 
  p_output_json
);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT check_transaction_status(p_corr_id);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞
SELECT check_figurant_status(p_source_id, p_list_code, p_name_figurant);
```


### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏

```sql
-- –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
SELECT ksk_create_partitions('ksk_result', CURRENT_DATE, 7);

-- –°–æ–∑–¥–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
SELECT ksk_create_partitions_for_all_tables(CURRENT_DATE, 7);

-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
SELECT ksk_drop_old_partitions('ksk_result', 365);

-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π
SELECT * FROM ksk_list_partitions('ksk_result');
```


### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤

```sql
-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
SELECT ksk_run_report(
  p_report_code,      -- 'totals', 'figurants', etc.
  p_initiator,        -- 'system' –∏–ª–∏ 'user'
  p_user_login,       -- NULL –¥–ª—è system
  p_start_date,
  p_end_date,         -- NULL = p_start_date
  p_parameters        -- JSONB –∏–ª–∏ NULL
);

-- –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ—Ç—á—ë—Ç–æ–≤
SELECT ksk_cleanup_old_reports();
```


### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- –ó–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –ª–æ–≥
SELECT ksk_log_operation(
  p_operation_code,
  p_operation_name,
  p_start_time,
  p_status,
  p_info,
  p_error_message
);
```


***

## pg_cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

```sql
-- 02:00 - –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ 7 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
SELECT ksk_create_partitions_for_all_tables(CURRENT_DATE, 7);

-- 03:00 - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤
SELECT ksk_run_report('totals', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('totals_by_payment_type', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('list_totals', 'system', NULL, CURRENT_DATE - 1);
SELECT ksk_run_report('list_totals_by_payment_type', 'system', NULL, CURRENT_DATE - 1);

-- 04:00 - –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (>365 –¥–Ω–µ–π)
SELECT ksk_drop_old_partitions('ksk_result', 365);
SELECT ksk_drop_old_partitions('ksk_figurant', 365);
SELECT ksk_drop_old_partitions('ksk_figurant_match', 365);

-- 04:00 - –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π (>14 –¥–Ω–µ–π)
SELECT ksk_cleanup_empty_records(14);

-- 04:00 - –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (>7 –¥–Ω–µ–π)
SELECT ksk_cleanup_empty_partitions('ksk_result', 7);
SELECT ksk_cleanup_empty_partitions('ksk_figurant', 7);
SELECT ksk_cleanup_empty_partitions('ksk_figurant_match', 7);

-- 05:00 - –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ—Ç—á—ë—Ç–æ–≤ (–ø–æ TTL)
SELECT ksk_cleanup_old_reports();
```


***

## –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å

```sql
-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT 
  COUNT(*) AS total,
  COUNT(*) FILTER (WHERE resolution = 'allow') AS allow_count,
  COUNT(*) FILTER (WHERE resolution = 'review') AS review_count,
  COUNT(*) FILTER (WHERE resolution = 'deny') AS deny_count,
  COUNT(*) FILTER (WHERE has_bypass = 'yes') AS bypass_count
FROM ksk_result
WHERE date = CURRENT_DATE;

-- –ü–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π
SELECT 
  payment_type,
  COUNT(*) AS total
FROM ksk_result
WHERE date = CURRENT_DATE
GROUP BY payment_type
ORDER BY total DESC;

-- –ü–æ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–∞–º
SELECT 
  unnest(list_codes) AS list_code,
  COUNT(*) AS count
FROM ksk_result
WHERE date = CURRENT_DATE
  AND list_codes IS NOT NULL
GROUP BY list_code
ORDER BY count DESC;
```


### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```sql
-- Bloat —Ç–∞–±–ª–∏—Ü
SELECT * FROM ksk_monitor_table_bloat('upoa_ksk_reports');

-- –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'upoa_ksk_reports'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- –°—Ç–∞—Ç—É—Å –æ—Ç—á—ë—Ç–æ–≤
SELECT 
  r.report_code,
  h.status,
  h.start_date,
  h.end_date,
  h.created_at,
  h.completed_at,
  h.error_message
FROM ksk_report_header h
JOIN ksk_report_orchestrator r ON h.report_code = r.report_code
WHERE h.created_at > CURRENT_DATE - 7
ORDER BY h.created_at DESC;

-- –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π
SELECT *
FROM ksk_system_operation_log
WHERE start_time > CURRENT_DATE - 1
ORDER BY start_time DESC;
```


***

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (TODO)

1. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤ (DONE - —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 5-10 —Ä–∞–∑)
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (DONE - 27 –º–µ—Ç—Ä–∏–∫, 3 dashboard)
3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (DONE - pg_cron)
4. ‚è≥ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Web UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á—ë—Ç–æ–≤
5. ‚è≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (LDAP/AD)
6. ‚è≥ –ê–ª–µ—Ä—Ç–∏–Ω–≥ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Email/Telegram/SMS)
7. ‚è≥ Disaster Recovery –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (backup/restore —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. ‚è≥ Load Testing (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É >1500 msg/sec)

***

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ë–î:** Database Developer/Engineer
**–Ø–∑—ã–∫ —Å–∏—Å—Ç–µ–º—ã:** –†—É—Å—Å–∫–∏–π
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 28.10.2025

**–î–æ–∫—É–º–µ–Ω—Ç—ã:**

- Business Requirements (–±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
- Monitoring Specification (—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
- Report Specification (—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤)
- HTML Monitoring Dashboard
- CSV Metrics Export

***

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ –≤ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å AI –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º.
<span style="display:none">[^1][^10][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://kskgroup.ru

[^2]: https://kskspr.ru/documents/main/?id=1634

[^3]: https://kb.msk-ix.ru/dns/ksk/

[^4]: https://www.kck.ru/bpm-system-process-management

[^5]: https://denuo.legal/ru/insights/news/A6/

[^6]: https://kskgroup.ru/press-center/news/liberalizatsiya-korporativnogo-zakonodatelstva/

[^7]: https://minfin.gov.ru/ru/permission/

[^8]: https://www.garant.ru/article/886139/

[^9]: https://samojlovskij-r64.gosweb.gosuslugi.ru/ofitsialno/struktura-munitsipalnogo-obrazovaniya/kontrolno-schetnyy-organ-munitsipalnogo-obrazovaniya/otchety-xk-o-provedennyh-proverkah/

[^10]: https://solutions.1c.ru/projects/1104415/

