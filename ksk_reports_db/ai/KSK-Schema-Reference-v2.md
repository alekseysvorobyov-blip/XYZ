# Schema Reference –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ö–°–ö v2.0

**–ò—Å—Ç–æ—á–Ω–∏–∫:** ksk_full_migration-20251029-003.txt  
**–°—Ö–µ–º–∞ –ë–î:** upoa_ksk_reports  
**PostgreSQL –≤–µ—Ä—Å–∏—è:** 16  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:** 30.10.2025 17:30 MSK  
**–í–µ—Ä—Å–∏—è:** 2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã has_bypass/is_bypass, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã –æ—Ç—á—ë—Ç–æ–≤, —Ñ—É–Ω–∫—Ü–∏–∏, pg_cron)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã** –¥–ª—è –≤—Å–µ—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –æ–±—ä–µ–∫—Ç–æ–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã –ö–°–ö. –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î –¥–æ–ª–∂–Ω—ã –æ—Å–Ω–æ–≤—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π.

---

## üìã –†–ê–ó–î–ï–õ 1: –ü–µ—Ä–µ—á–∏—Å–ª—è–µ–º—ã–µ —Ç–∏–ø—ã –∏ constraints

### 1.1 payment_type

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(20)`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** I, O, T, M, V  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** COMMENT ON TABLE ksk_report_totals_by_payment_type_data

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| I | –í—Ö–æ–¥—è—â–∏–π |
| O | –ò—Å—Ö–æ–¥—è—â–∏–π |
| T | –¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–π |
| M | –ú–µ–∂—Ñ–∏–ª–∏–∞–ª—å–Ω—ã–π |
| V | –í–Ω—É—Ç—Ä–∏—Ñ–∏–ª–∏–∞–ª—å–Ω—ã–π |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–∞—Ö –∫–æ–ª–æ–Ω–æ–∫ –æ—Ç—á—ë—Ç–æ–≤ (i_*, o_*, t_*, m_*, v_*)

---

### 1.2 resolution

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(20)`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** allow, review, deny, empty  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** COMMENT ON COLUMN ksk_result.resolution

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| allow | –†–∞–∑—Ä–µ—à–µ–Ω–æ |
| review | –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É |
| deny | –ó–∞–ø—Ä–µ—â–µ–Ω–æ |
| empty | –ë–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ |

---

### 1.3 has_bypass (–≤ ksk_result) ‚ö†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–û

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(10)`  
**–¢–∞–±–ª–∏—Ü–∞:** `ksk_result`  
**Default:** `'empty'`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–∑–Ω–∞–∫ –Ω–∞–ª–∏—á–∏—è —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –≤ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò  
**–ó–Ω–∞—á–µ–Ω–∏—è:** yes, no, empty  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** COMMENT ON COLUMN ksk_result.has_bypass + –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| yes | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ò–ú–ï–ï–¢ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ (bypass) |
| no | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï –∏–º–µ–µ—Ç —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ |
| empty | –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ (–ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏) |

---

### 1.4 is_bypass (–≤ ksk_figurant) ‚ö†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–û

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(10)`  
**–¢–∞–±–ª–∏—Ü–∞:** `ksk_figurant`  
**Default:** `'no'`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–∑–Ω–∞–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –§–ò–ì–£–†–ê–ù–¢–ê –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏  
**–ó–Ω–∞—á–µ–Ω–∏—è:** yes, no  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** COMMENT ON COLUMN ksk_figurant.is_bypass + –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| yes | –§–∏–≥—É—Ä–∞–Ω—Ç –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ (bypass –ø—Ä–∏–º–µ–Ω—ë–Ω) |
| no | –§–∏–≥—É—Ä–∞–Ω—Ç –ù–ï –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ |

**–ö–†–ò–¢–ò–ß–ù–û:** –≠—Ç–æ –¥–≤–∞ –†–ê–ó–ù–´–• –ø–æ–ª—è —Å —Ä–∞–∑–Ω—ã–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º:
- `has_bypass` - —É—Ä–æ–≤–µ–Ω—å –¢–†–ê–ù–ó–ê–ö–¶–ò–ò (–µ—Å—Ç—å –ª–∏ —Ñ–∏–≥—É—Ä–∞–Ω—Ç—ã —Å bypass)
- `is_bypass` - —É—Ä–æ–≤–µ–Ω—å –§–ò–ì–£–†–ê–ù–¢–ê (–∏—Å–∫–ª—é—á—ë–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–≥—É—Ä–∞–Ω—Ç)

---

### 1.5 president_group

**–¢–∏–ø –ø–æ–ª—è:** `TEXT`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** none, part, full  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** ksk_figurant.president_group

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| none | –ù–µ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫—É—é –≥—Ä—É–ø–ø—É |
| part | –ß–∞—Å—Ç–∏—á–Ω–æ –≤ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–æ–π –≥—Ä—É–ø–ø–µ |
| full | –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–æ–π –≥—Ä—É–ø–ø–µ |

---

### 1.6 initiator (–¥–ª—è –æ—Ç—á—ë—Ç–æ–≤)

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(100)`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** system, user  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** CHECK constraint –Ω–∞ ksk_report_header.initiator

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| system | –°–∏—Å—Ç–µ–º–Ω—ã–π –æ—Ç—á—ë—Ç |
| user | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ—Ç—á—ë—Ç |

---

### 1.7 report_status

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(20)`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** created, in_progress, done, error  
**Default:** `'created'`  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** CHECK constraint –Ω–∞ ksk_report_header.status

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| created | –°–æ–∑–¥–∞–Ω |
| in_progress | –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
| done | –ó–∞–≤–µ—Ä—à—ë–Ω |
| error | –û—à–∏–±–∫–∞ |

---

### 1.8 operation_status

**–¢–∏–ø –ø–æ–ª—è:** `VARCHAR(20)`  
**–ó–Ω–∞—á–µ–Ω–∏—è:** success, error  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** CHECK constraint –Ω–∞ ksk_system_operations_log.status

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ |
|----------|-------------|
| success | –£—Å–ø–µ—à–Ω–æ |
| error | –û—à–∏–±–∫–∞ |

---

## üìä –†–ê–ó–î–ï–õ 2: –¢–∞–±–ª–∏—Ü—ã

### 2.1 –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Ç–∞–±–ª–∏—Ü—ã (5 —Ç–∞–±–ª–∏—Ü)

#### 2.1.1 ksk_result
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ö–°–ö (~3M –∑–∞–ø–∏—Å–µ–π/–¥–µ–Ω—å, ~3TB/–≥–æ–¥)
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** PARTITION BY RANGE (output_timestamp), –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 39
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 5
- **–ö–∞—Å–∫–∞–¥—ã:** ON DELETE CASCADE ‚Üí ksk_figurant

#### 2.1.2 ksk_figurant
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∏–≥—É—Ä–∞–Ω—Ç—ã –∏–∑ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** PARTITION BY RANGE (timestamp)
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 14
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 5
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** source_id REFERENCES ksk_result(id, output_timestamp) ON DELETE CASCADE
- **–ö–∞—Å–∫–∞–¥—ã:** ON DELETE CASCADE ‚Üí ksk_figurant_match

#### 2.1.3 ksk_figurant_match
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º (–∞–ª–≥–æ—Ä–∏—Ç–º—ã, –ø–æ–ª—è, –∑–Ω–∞—á–µ–Ω–∏—è)
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** PARTITION BY RANGE (timestamp)
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 9
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 3
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** figurant_id REFERENCES ksk_figurant(id, timestamp) ON DELETE CASCADE

#### 2.1.4 ksk_system_operations_log
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ñ—É—Ä–Ω–∞–ª —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–∞—Ä—Ç–∏—Ü–∏–∏, –æ—Ç—á—ë—Ç—ã, cleanup)
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 8
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 3

#### 2.1.5 ksk_result_error
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON –≤ —Ñ—É–Ω–∫—Ü–∏–∏ put_ksk_result
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 13
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 5
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** JSONB –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç EXTERNAL STORAGE

---

### 2.2 –¢–∞–±–ª–∏—Ü—ã –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ (7 —Ç–∞–±–ª–∏—Ü) ‚ú® –î–û–ë–ê–í–õ–ï–ù–û

#### 2.2.1 ksk_report_orchestrator
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–∞—Å—Ç–µ—Ä-—Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á—ë—Ç–æ–≤
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 8
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - –°–æ–¥–µ—Ä–∂–∏—Ç 5 –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á—ë—Ç–æ–≤
  - TTL –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤: 365 –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - TTL –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤: 7-14 –¥–Ω–µ–π

#### 2.2.2 ksk_report_header
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –æ—Ç—á—ë—Ç–æ–≤ —Å –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 12
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 4
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** orchestrator_id REFERENCES ksk_report_orchestrator(id) ON DELETE CASCADE
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - CHECK constraint: initiator='user' —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è userlogin
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç remove_date –Ω–∞ –æ—Å–Ω–æ–≤–µ TTL

#### 2.2.3 ksk_report_totals_data
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞: –æ–±—â–∏–µ –∏—Ç–æ–≥–∏ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –±–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 9
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 2
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** report_header_id REFERENCES ksk_report_header(id) ON DELETE CASCADE

#### 2.2.4 ksk_report_list_totals_data
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –≤ —Ä–∞–∑—Ä–µ–∑–µ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 9
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 3
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** report_header_id REFERENCES ksk_report_header(id) ON DELETE CASCADE

#### 2.2.5 ksk_report_totals_by_payment_type_data
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –ø–æ 5 —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π (I/O/T/M/V)
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 44 (–æ–±—â–∏–µ + –ø–æ 8 –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ –∫–∞–∂–¥—ã–π –∏–∑ 5 —Ç–∏–ø–æ–≤)
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 1
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** report_header_id REFERENCES ksk_report_header(id) ON DELETE CASCADE
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - –ö–æ–ª–æ–Ω–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏: i_*, o_*, t_*, m_*, v_*
  - –ö–∞–∂–¥—ã–π –ø—Ä–µ—Ñ–∏–∫—Å —Å–æ–¥–µ—Ä–∂–∏—Ç: total, total_without_result, total_with_result, total_allow, total_review, total_deny, total_bypass

#### 2.2.6 ksk_report_list_totals_by_payment_type_data
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –ø–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–µ–∑–µ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 39
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 2
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** report_header_id REFERENCES ksk_report_header(id) ON DELETE CASCADE

#### 2.2.7 ksk_report_figurants_data
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º (—Å–ø–∏—Å–∫–∏, –≥—Ä—É–ø–ø—ã, –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–ï–¢
- **–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫:** 12
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 1
- **–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á:** report_header_id REFERENCES ksk_report_header(id) ON DELETE CASCADE

---

## üîß –†–ê–ó–î–ï–õ 3: –§—É–Ω–∫—Ü–∏–∏ ‚ú® –î–û–ë–ê–í–õ–ï–ù–û

### 3.1 –°–ª—É–∂–µ–±–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã

#### add_column_if_not_exists(p_table_name text, p_column_name text, p_column_type text, p_column_default text DEFAULT NULL)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** void
- **–Ø–∑—ã–∫:** plpgsql

#### jsonb_object_length(input_data jsonb)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥—Å—á—ë—Ç –¥–ª–∏–Ω—ã JSONB –æ–±—ä–µ–∫—Ç–∞/–º–∞—Å—Å–∏–≤–∞
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** integer
- **–Ø–∑—ã–∫:** sql IMMUTABLE PARALLEL SAFE

---

### 3.2 –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

#### ksk_create_partitions_for_all_tables(p_start_date date, p_days_ahead integer DEFAULT 30)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω–∞ N –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
- **–¢–∞–±–ª–∏—Ü—ã:** ksk_result, ksk_figurant, ksk_figurant_match
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(log_id integer, partitions_created text[], execution_time interval)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ksk_system_operations_log

#### ksk_drop_old_partitions(days_to_keep integer DEFAULT 365)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é >365 –¥–Ω–µ–π)
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(log_id integer, dropped_partitions text[], execution_time interval)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –° –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –ø—É—Å—Ç–æ—Ç—É

#### ksk_cleanup_empty_partitions(table_name text DEFAULT 'ksk_result', days_old integer DEFAULT 7)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(log_id integer, deleted_partitions text[], execution_time interval)
- **–Ø–∑—ã–∫:** plpgsql
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
  - table_name: 'all' –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
  - days_old: –≤–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä—Ç–∏—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π)

---

### 3.3 –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### ksk_cleanup_empty_records(days_old integer DEFAULT 14)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å resolution='empty' –∏–∑ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π + —É–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(deleted_count bigint, dropped_partitions text[], execution_time interval)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** 
  - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å ksk_result
  - –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç VACUUM ANALYZE

#### ksk_cleanup_with_logging(days_old integer DEFAULT 14)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è ksk_cleanup_empty_records —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(log_id integer, empty_records_deleted bigint, partitions_dropped text[], total_time interval)
- **–Ø–∑—ã–∫:** plpgsql

#### ksk_cleanup_old_reports()
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –ø–æ TTL –∏–∑ ksk_report_header
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** integer (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ remove_date –∏–∑ ksk_report_header
  - –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ ON DELETE CASCADE

#### ksk_cleanup_old_logs(p_days_to_keep integer DEFAULT 365)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ ksk_system_operations_log
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** integer (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π)
- **–Ø–∑—ã–∫:** plpgsql
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ 365 –¥–Ω–µ–π

---

### 3.4 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### ksk_monitor_table_bloat()
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bloat –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å –∞–ª–µ—Ä—Ç–∏–Ω–≥–æ–º
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** JSON (–æ—Ç—á—ë—Ç –ø–æ bloat –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü)
- **–Ø–∑—ã–∫:** plpgsql
- **–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
  - Bloat > 30% ‚Üí status='error', –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å err_msg
  - Bloat 15-30% ‚Üí warning
  - Bloat < 15% ‚Üí healthy
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –≤ ksk_system_operations_log

---

### 3.5 –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

#### check_figurant_status(input_data jsonb)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ presidentGroup, autoLogin, exclusions
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TEXT (allow/review/deny/unknown)
- **–Ø–∑—ã–∫:** plpgsql IMMUTABLE
- **–õ–æ–≥–∏–∫–∞:** –†–µ–∞–ª–∏–∑—É–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ö–°–ö

#### check_transaction_status(input_data jsonb)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TEXT (allow/review/deny/empty)
- **–Ø–∑—ã–∫:** plpgsql IMMUTABLE
- **–õ–æ–≥–∏–∫–∞:**
  - –•–æ—Ç—è –±—ã –æ–¥–∏–Ω deny ‚Üí deny
  - –•–æ—Ç—è –±—ã –æ–¥–∏–Ω review ‚Üí review
  - –í—Å–µ allow ‚Üí allow
  - –ù–µ—Ç —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤ ‚Üí empty

---

### 3.6 –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö

#### put_ksk_result(...)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ö–°–ö —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –ø–æ–ª–µ–π
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** ~13 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (timestamps, kafka metadata, input_json, output_json –∏ —Ç.–¥.)
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** TABLE(new_result_id integer, figurants_count integer, matches_count integer)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
  - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON ‚Üí –∑–∞–ø–∏—Å—å –≤ ksk_result_error
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –∏–∑ JSON
  - –ö–∞—Å–∫–∞–¥–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ ksk_figurant –∏ ksk_figurant_match

---

### 3.7 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤

#### ksk_run_report(p_report_code varchar, p_initiator varchar, p_user_login varchar, p_start_date date, p_end_date date, p_parameters jsonb DEFAULT NULL)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ª—é–±–æ–≥–æ –æ—Ç—á—ë—Ç–∞
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** INTEGER (ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –≤ ksk_report_header)
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
  - –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ ksk_report_header
  - –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ –∏–∑ ksk_report_orchestrator
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ finished_datetime
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ksk_system_operations_log

#### ksk_report_totals(p_report_header_id integer, p_start_date date, p_end_date date)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞: –æ–±—â–∏–µ –∏—Ç–æ–≥–∏ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
- **–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:** ksk_report_totals_data

#### ksk_report_list_totals(p_report_header_id integer, p_start_date date, p_end_date date)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –≤ —Ä–∞–∑—Ä–µ–∑–µ —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- **–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:** ksk_report_list_totals_data

#### ksk_report_totals_by_payment_type(p_report_header_id integer, p_start_date date, p_end_date date)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –ø–æ 5 —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π
- **–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:** ksk_report_totals_by_payment_type_data

#### ksk_report_list_totals_by_payment_type(p_report_header_id integer, p_start_date date, p_end_date date)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞: –∏—Ç–æ–≥–∏ –ø–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–µ–∑–µ —Å–ø–∏—Å–∫–æ–≤
- **–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:** ksk_report_list_totals_by_payment_type_data

#### ksk_report_figurants(p_report_header_id integer, p_start_date date, p_end_date date, p_parameters jsonb DEFAULT NULL)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º
- **–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:** ksk_report_figurants_data
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ {"list_codes": ["4200", "4204"]} –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

### 3.8 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### ksk_log_operation(p_operation_code varchar, p_operation_name varchar, p_begin_time timestamp, p_status varchar, p_info text, p_err_msg text DEFAULT NULL)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** INTEGER (ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏)
- **–¢–∞–±–ª–∏—Ü–∞:** ksk_system_operations_log
- **–Ø–∑—ã–∫:** plpgsql
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç duration = NOW() - p_begin_time

---

## ‚è∞ –†–ê–ó–î–ï–õ 4: pg_cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚ú® –î–û–ë–ê–í–õ–ï–ù–û

### 4.1 –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏

| –í—Ä–µ–º—è | Job Name | –û–ø–∏—Å–∞–Ω–∏–µ | –§—É–Ω–∫—Ü–∏—è |
|-------|----------|----------|---------|
| 00:30 | ksk_analyze_yesterday_partitions | ANALYZE –ø–∞—Ä—Ç–∏—Ü–∏–π –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å | Custom DO block |
| 01:00 | ksk_create_future_partitions | –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ 7 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥ | ksk_create_partitions_for_all_tables() |
| 01:30 | ksk_generate_system_reports | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ | ksk_run_report() –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ |
| 02:00 | ksk_drop_old_partitions | –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π —Å—Ç–∞—Ä—à–µ 365 –¥–Ω–µ–π | ksk_drop_old_partitions(365) |
| 03:00 | ksk_cleanup_empty_records | –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å resolution='empty' | ksk_cleanup_empty_records(14) |
| 03:30 | ksk_cleanup_empty_partitions | –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π | ksk_cleanup_empty_partitions('all', 14) |
| 04:00 | ksk_cleanup_old_reports | –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –ø–æ TTL | ksk_cleanup_old_reports() |
| 04:30 | ksk_cleanup_old_logs | –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ 365 –¥–Ω–µ–π | ksk_cleanup_old_logs(365) |
| 05:00 | ksk_vacuum_main_tables | VACUUM ANALYZE –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü | Custom DO block |

### 4.2 –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

| –í—Ä–µ–º—è | Job Name | –û–ø–∏—Å–∞–Ω–∏–µ | –ß–∞—Å—Ç–æ—Ç–∞ |
|-------|----------|----------|---------|
| 04:00 | ksk_monitor_bloat | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bloat –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö | –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0 4 * * 0) |

### 4.3 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pg_cron

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á:
```sql
SELECT * FROM upoa_ksk_reports.ksk_cron_monitoring 
WHERE health_status IN ('ERROR', 'STALE', 'DISABLED');
```

#### View –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- **ksk_cron_monitoring** - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∑–∞–¥–∞—á–∞–º pg_cron
  - –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫
  - –°—Ç–∞—Ç—É—Å (OK/ERROR/STALE/DISABLED)
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π
  - –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## üîó –†–ê–ó–î–ï–õ 5: –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

### 5.1 –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Ç–∞–±–ª–∏—Ü—ã

```
ksk_result (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
   ‚îÇ
   ‚îÇ source_id (FK, ON DELETE CASCADE)
   ‚îú‚îÄ‚îÄ> ksk_figurant (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∏–≥—É—Ä–∞–Ω—Ç—ã)
          ‚îÇ
          ‚îÇ figurant_id (FK, ON DELETE CASCADE)
          ‚îî‚îÄ‚îÄ> ksk_figurant_match (—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º)
```

### 5.2 –¢–∞–±–ª–∏—Ü—ã –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏

```
ksk_report_orchestrator (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –æ—Ç—á—ë—Ç–æ–≤)
   ‚îÇ
   ‚îÇ orchestrator_id (FK, ON DELETE CASCADE)
   ‚îú‚îÄ‚îÄ> ksk_report_header (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—á—ë—Ç–æ–≤)
          ‚îÇ
          ‚îÇ report_header_id (FK, ON DELETE CASCADE)
          ‚îú‚îÄ‚îÄ> ksk_report_totals_data
          ‚îú‚îÄ‚îÄ> ksk_report_list_totals_data
          ‚îú‚îÄ‚îÄ> ksk_report_totals_by_payment_type_data
          ‚îú‚îÄ‚îÄ> ksk_report_list_totals_by_payment_type_data
          ‚îî‚îÄ‚îÄ> ksk_report_figurants_data
```

---

## ‚ö†Ô∏è –†–ê–ó–î–ï–õ 6: –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í–µ—Ä—Å–∏—è 1.0 ‚Üí 2.0

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: has_bypass vs is_bypass
**–ë—ã–ª–æ:** –û–ø–∏—Å–∞–Ω–∏–µ –±—ã–ª–æ –Ω–µ—Ç–æ—á–Ω—ã–º, –Ω–µ –æ—Ç—Ä–∞–∂–∞–ª–æ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —É—Ä–æ–≤–Ω–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞  
**–°—Ç–∞–ª–æ:** 
- `has_bypass` (ksk_result) - —É—Ä–æ–≤–µ–Ω—å –¢–†–ê–ù–ó–ê–ö–¶–ò–ò: –µ—Å—Ç—å –ª–∏ —Ñ–∏–≥—É—Ä–∞–Ω—Ç—ã —Å bypass
- `is_bypass` (ksk_figurant) - —É—Ä–æ–≤–µ–Ω—å –§–ò–ì–£–†–ê–ù–¢–ê: –∏—Å–∫–ª—é—á—ë–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–≥—É—Ä–∞–Ω—Ç

#### –î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≤–µ—Ä—Å–∏–∏ 2.0:
- ‚úÖ 7 —Ç–∞–±–ª–∏—Ü –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ 20 —Ñ—É–Ω–∫—Ü–∏–π —Å–∏—Å—Ç–µ–º—ã —Å —Å–∏–≥–Ω–∞—Ç—É—Ä–∞–º–∏ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
- ‚úÖ 10 –∑–∞–¥–∞—á pg_cron —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ View –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ pg_cron

---

## üìù –†–ê–ó–î–ï–õ 7: –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

1. **–í–°–ï–ì–î–ê** —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ—Å–ª–æ–≤–Ω–æ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
2. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –¥–æ–¥—É–º—ã–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º—ã—Ö —Ç–∏–ø–æ–≤
3. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
4. **–ö–†–ò–¢–ò–ß–ù–û:** –†–∞–∑–ª–∏—á–∞—Ç—å has_bypass (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è) –∏ is_bypass (—Ñ–∏–≥—É—Ä–∞–Ω—Ç)
5. –ü—Ä–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏ - –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
6. –£–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª –∏ –≤–µ—Ä—Å–∏—é —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –≤ –æ—Ç–≤–µ—Ç–∞—Ö
7. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ - –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏

---

**–ö–æ–Ω–µ—Ü —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ v2.0**
