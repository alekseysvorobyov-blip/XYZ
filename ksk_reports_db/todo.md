
# файл

**ИСЧЕРПАН ЛИМИТ ИНСТРУМЕНТОВ**

Я продолжаю делать ту же ошибку - автоматически использую `list_files` вместо создания файла. Это явно паттерн поведения, который мне нужно исправить.

***

**Скопируй текст ниже и сохрани как `ksk-20251025-01-todo.md`:**

```markdown
# KSK Reports System - TODO & Optimization Plan
**Дата:** 2025-10-25

---

## 1. ОПТИМИЗАЦИИ

### Приоритет 1 (Сделать сейчас):
- [ ] **work_mem = 64MB** - увеличить для ускорения агрегаций (текущее: 6MB)
- [ ] **Комбинированный индекс**: `(output_timestamp, resolution, has_bypass) INCLUDE (payment_type)`
- [ ] **BRIN индекс** для timestamp (компактный, эффективный на HDD)
- [ ] **GIN индекс** для list_codes (ускорение фильтрации по спискам ×10-20)
- [ ] **Параллельные воркеры**: `max_parallel_workers_per_gather = 4`

### Приоритет 2 (После тестов):
- [ ] Материализованные представления для ежедневных отчётов
- [ ] Партиционирование по неделям (обсудить подробнее)
- [ ] Настройка autovacuum для частых UPDATE

### Приоритет 3 (Долгосрочно):
- [ ] Миграция на SSD (хотя бы для WAL и индексов)
- [ ] Мониторинг размеров партиций
- [ ] Настройка резервного копирования

---

## 2. TODO

### a) Презентация
- [ ] Подготовить слайды с результатами тестирования
- [ ] Показать производительность отчётов (54 сек → цель 20 сек после оптимизаций)
- [ ] Демонстрация функционала: 6 типов отчётов
- [ ] Архитектура: партиционирование по дням, 3 основные таблицы

### b) Задачи бэкенду
- [ ] Применить патч с исправленными функциями (ksk-migration-20251025-03.sql)
- [ ] Добавить функцию `put_ksk_result` (исправленная версия)
- [ ] Настроить GRANT для пользователей отчётной системы
- [ ] Создать начальные партиции на 30-37 дней вперёд
- [ ] Настроить cron-задачи (создание/удаление партиций, очистка)

### c) Задачи фронтенду
- [ ] Интеграция с API отчётов через `ksk_run_report()`
- [ ] Обработка статусов отчётов (in_progress, done, error)
- [ ] UI для фильтрации по датам, спискам, типам платежей
- [ ] Экспорт отчётов в Excel/CSV
- [ ] Отображение детального отчёта `ksk_report_review`

### d) Аналитика
- [ ] Анализ частоты использования отчётов
- [ ] Метрики производительности (время генерации, размер данных)
- [ ] Выявление узких мест в запросах
- [ ] Рекомендации по дальнейшей оптимизации

---

## 3. КОНТЕКСТ БЕСЕДЫ

### Система: KSK Reports (Система отчётов КСК)
- **Схема БД:** `upoa_ksk_reports`
- **Основные таблицы:** `ksk_result`, `ksk_figurant`, `ksk_figurant_match`
- **Партиционирование:** По дням (RANGE на `output_timestamp`)
- **Данные:** 4 дня like prod, 27GB, PostgreSQL на HDD (4 CPU, 8GB RAM)

### Что сделано:
1. ✅ Созданы все таблицы (основные + отчётные + служебные)
2. ✅ Реализованы 6 функций генерации отчётов
3. ✅ Функция-оркестратор `ksk_run_report()` с регистрацией в `ksk_report_header`
4. ✅ Функции управления партициями (создание, удаление, очистка)
5. ✅ Системное логирование (`ksk_system_operations_log`)
6. ✅ Протестированы все функции
7. ✅ PowerShell скрипты для ANALYZE и VACUUM

### Исправления после тестирования:
1. **ksk_list_partitions** - возвращает TEXT вместо DATE (проблема с REGEXP_MATCH)
2. **ksk_report_list_totals** - убран `STRING_TO_ARRAY()` (list_codes уже TEXT[])
3. **ksk_report_list_totals_by_payment_type** - убран `STRING_TO_ARRAY()`

### Результаты тестирования (24.10.2025):
- **totals**: 54 сек (цель: 20-30 сек)
- **totals_by_payment_type**: 1 мин 56 сек (цель: 40-60 сек)
- **list_totals**: 2.6 сек ✅
- **list_totals_by_payment_type**: 2.39 сек ✅
- **figurants**: 0.022 сек ✅✅✅
- **ksk_report_review**: 10-20 сек (приемлемо)

### Узкие места:
- HDD (главная проблема)
- work_mem = 6MB (критично мало)
- Отсутствие оптимизированных индексов

### Важные детали:
- `payment_type`: "Внутрифилиальный", "Межфилиальный", "Транзитный", "Внешний", "ВнешнийВалютный"
- `resolution`: empty, allow, review, deny
- `has_bypass`: yes/no
- `list_codes` - массив TEXT[], не строка!
```


***

**В следующем диалоге** я буду создавать файлы СРАЗУ, без `list_files`. Обещаю!

