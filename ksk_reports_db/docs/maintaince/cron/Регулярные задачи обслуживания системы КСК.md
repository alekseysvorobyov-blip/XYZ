
# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ö–°–ö

> **–í–µ—Ä—Å–∏—è:** 1.0
> **–î–∞—Ç–∞:** 28 –æ–∫—Ç—è–±—Ä—è 2025
> **–ü—Ä–æ–µ–∫—Ç:** –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–ö–°–ö)
> **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL 13+

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ö–°–ö.

***

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏

| \# | –í—Ä–µ–º—è | –ó–∞–¥–∞—á–∞ | –§—É–Ω–∫—Ü–∏—è/SQL | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 1 | 00:30 | ANALYZE –≤—á–µ—Ä–∞—à–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π | SQL-–±–ª–æ–∫ | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ~1 –º–∏–Ω |
| 2 | 01:00 | –°–æ–∑–¥–∞–Ω–∏–µ –±—É–¥—É—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (7 –¥–Ω–µ–π) | `ksk_create_partitions_for_all_tables(CURRENT_DATE, 7)` | –í—ã—Å–æ–∫–∏–π | ~2 –º–∏–Ω |
| 3 | 01:30 | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ | SQL-–±–ª–æ–∫ (—Ü–∏–∫–ª –ø–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—É) | –í—ã—Å–æ–∫–∏–π | ~30 –º–∏–Ω |
| 4 | 02:00 | –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ–¥–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (>365 –¥–Ω–µ–π) | `ksk_drop_old_partitions(365)` | –°—Ä–µ–¥–Ω–∏–π | ~5 –º–∏–Ω |
| 5 | 03:00 | –£–¥–∞–ª–µ–Ω–∏–µ empty –∑–∞–ø–∏—Å–µ–π (>14 –¥–Ω–µ–π) | `ksk_cleanup_empty_records(14)` | –°—Ä–µ–¥–Ω–∏–π | ~3 –º–∏–Ω |
| 6 | 03:30 | –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (>14 –¥–Ω–µ–π) | `ksk_cleanup_empty_partitions('all', 14)` | –°—Ä–µ–¥–Ω–∏–π | ~5 –º–∏–Ω |
| 7 | 04:00 | –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ (–ø–æ TTL) | `ksk_cleanup_old_reports()` | –°—Ä–µ–¥–Ω–∏–π | ~2 –º–∏–Ω |
| 8 | 04:30 | –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ (>365 –¥–Ω–µ–π) | `ksk_cleanup_old_logs(365)` | –ù–∏–∑–∫–∏–π | ~1 –º–∏–Ω |
| 9 | 05:00 | VACUUM –≥–ª–∞–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü | SQL-–±–ª–æ–∫ (VACUUM ANALYZE) | –í—ã—Å–æ–∫–∏–π | ~5-10 –º–∏–Ω |

**–ò—Ç–æ–≥–æ:** ~54-59 –º–∏–Ω—É—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

| \# | –î–µ–Ω—å | –í—Ä–µ–º—è | –ó–∞–¥–∞—á–∞ | –§—É–Ω–∫—Ü–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| :-- | :-- | :-- | :-- | :-- | :-- | :-- |
| 10 | –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ | 04:00 | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bloat | `ksk_monitor_table_bloat()` | –°—Ä–µ–¥–Ω–∏–π | ~30 —Å–µ–∫ |


***

## üìù –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

### –ó–∞–¥–∞—á–∞ \#1: ANALYZE –≤—á–µ—Ä–∞—à–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π

**–í—Ä–µ–º—è:** 00:30
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ PostgreSQL

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—á–µ—Ä–∞—à–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏—è—Ö. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ—Ç—á—ë—Ç–æ–≤ ‚Äî –±–µ–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
DO $$
DECLARE
  v_date TEXT := TO_CHAR(CURRENT_DATE - 1, 'YYYYMMDD');
BEGIN
  EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_result_' || v_date;
  EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_figurant_' || v_date;
  EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_match_' || v_date;
END $$;
```

**–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã:**

- `part_ksk_result_YYYYMMDD` ‚Äî –≤—á–µ—Ä–∞—à–Ω—è—è –ø–∞—Ä—Ç–∏—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `part_ksk_figurant_YYYYMMDD` ‚Äî –≤—á–µ—Ä–∞—à–Ω—è—è –ø–∞—Ä—Ç–∏—Ü–∏—è —Ñ–∏–≥—É—Ä–∞–Ω—Ç–æ–≤
- `part_ksk_match_YYYYMMDD` ‚Äî –≤—á–µ—Ä–∞—à–Ω—è—è –ø–∞—Ä—Ç–∏—Ü–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

**–≠—Ñ—Ñ–µ–∫—Ç:**

- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤ –≤ 2-5 —Ä–∞–∑
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è JOIN-–æ–ø–µ—Ä–∞—Ü–∏–π

***

### –ó–∞–¥–∞—á–∞ \#2: –°–æ–∑–¥–∞–Ω–∏–µ –±—É–¥—É—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π

**–í—Ä–µ–º—è:** 01:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é –≤–ø–µ—Ä—ë–¥

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—ë—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ 7 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã –∏ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_create_partitions_for_all_tables(
  CURRENT_DATE,  -- –±–∞–∑–æ–≤–∞—è –¥–∞—Ç–∞
  7              -- –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
);
```

**–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

- `ksk_result` ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
- `ksk_figurant` ‚Äî –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞—Ö
- `ksk_match` ‚Äî —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

***

### –ó–∞–¥–∞—á–∞ \#3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤

**–í—Ä–µ–º—è:** 01:30
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ –¥–ª—è —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ `report_code` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `ksk_report_orchestrator` –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—Ç—á—ë—Ç—ã. –û—Ç—á—ë—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `initiator = 'system'` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 365 –¥–Ω–µ–π.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
DO $$
DECLARE
  rec RECORD;
BEGIN
  FOR rec IN 
    SELECT report_code 
    FROM upoa_ksk_reports.ksk_report_orchestrator
    ORDER BY report_code
  LOOP
    PERFORM upoa_ksk_reports.ksk_run_report(
      rec.report_code, 
      'system'
    );
  END LOOP;
END $$;
```

**–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –æ—Ç—á—ë—Ç—ã:**

- `totals` ‚Äî –æ–±—â–∏–µ –∏—Ç–æ–≥–∏ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, –ø—Ä–æ–ø—É—â–µ–Ω–æ, –∏—Ç–æ–≥–æ)
- `list_totals` ‚Äî –∏—Ç–æ–≥–∏ –ø–æ —Å–ø–∏—Å–∫–∞–º —Å–∞–Ω–∫—Ü–∏–π
- `totals_by_payment_type` ‚Äî –∏—Ç–æ–≥–∏ –ø–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π
- `list_totals_by_payment_type` ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–ø–∏—Å–∫–∞–º –∏ —Ç–∏–ø–∞–º

***

### –ó–∞–¥–∞—á–∞ \#4: –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ–¥–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π

**–í—Ä–µ–º—è:** 02:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–£–¥–∞–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 365 –¥–Ω–µ–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_drop_old_partitions(365);
```

**–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º–æ–≥–æ –º–µ—Å—Ç–∞:** ~50-100 GB –≤ –≥–æ–¥

***

### –ó–∞–¥–∞—á–∞ \#5: –£–¥–∞–ª–µ–Ω–∏–µ empty –∑–∞–ø–∏—Å–µ–π

**–í—Ä–µ–º—è:** 03:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `resolution = 'empty'` —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `ksk_result`.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_cleanup_empty_records(14);
```


***

### –ó–∞–¥–∞—á–∞ \#6: –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π

**–í—Ä–µ–º—è:** 03:30
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π –∏ —É–¥–∞–ª—è–µ—Ç —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã—Ö.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_cleanup_empty_partitions('all', 14);
```


***

### –ó–∞–¥–∞—á–∞ \#7: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤

**–í—Ä–µ–º—è:** 04:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤ –ø–æ TTL

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–£–¥–∞–ª—è–µ—Ç –æ—Ç—á—ë—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏:

- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—Ç—á—ë—Ç—ã: 365 –¥–Ω–µ–π
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã: 7-14 –¥–Ω–µ–π

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_cleanup_old_reports();
```


***

### –ó–∞–¥–∞—á–∞ \#8: –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤

**–í—Ä–µ–º—è:** 04:30
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –ª–æ–≥–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞ –ö–°–ö —Å—Ç–∞—Ä—à–µ 365 –¥–Ω–µ–π.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_cleanup_old_logs(365);
```


***

### –ó–∞–¥–∞—á–∞ \#9: VACUUM –≥–ª–∞–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

**–í—Ä–µ–º—è:** 05:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í—ã–ø–æ–ª–Ω—è–µ—Ç VACUUM ANALYZE –Ω–∞ –≥–ª–∞–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –ø–æ—Å–ª–µ –≤—Å–µ—Ö –Ω–æ—á–Ω—ã—Ö cleanup-–∑–∞–¥–∞—á. –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ –æ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫, –æ–±–Ω–æ–≤–ª—è–µ—Ç visibility map –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
DO $$
BEGIN
  -- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–≤–∫–ª—é—á–∞—è –≤—Å–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  VACUUM ANALYZE upoa_ksk_reports.ksk_result;
  VACUUM ANALYZE upoa_ksk_reports.ksk_figurant;
  VACUUM ANALYZE upoa_ksk_reports.ksk_match;
  
  -- –¢–∞–±–ª–∏—Ü—ã –æ—Ç—á—ë—Ç–æ–≤
  VACUUM ANALYZE upoa_ksk_reports.ksk_report_header;
  VACUUM ANALYZE upoa_ksk_reports.ksk_system_operations_log;
END $$;
```

**–í–∞–∂–Ω–æ:** `VACUUM ANALYZE` –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏.

***

## üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

### –ó–∞–¥–∞—á–∞ \#10: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bloat

**–î–µ–Ω—å:** –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
**–í—Ä–µ–º—è:** 04:00
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑–¥—É—Ç–∏—è —Ç–∞–±–ª–∏—Ü

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç "–º—ë—Ä—Ç–≤—ã—Ö" —Å—Ç—Ä–æ–∫ (bloat) –≤–æ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Ö–µ–º—ã `upoa_ksk_reports`. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `ksk_system_operations_log`.

**SQL —Å–∫—Ä–∏–ø—Ç:**

```sql
SELECT upoa_ksk_reports.ksk_monitor_table_bloat();
```

**–ü–æ—Ä–æ–≥–∏:**

- –ó–¥–æ—Ä–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã: bloat <15% ‚Üí —Å—Ç–∞—Ç—É—Å `success`
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: bloat 15-30% ‚Üí —Å—Ç–∞—Ç—É—Å `success` —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
- –ö—Ä–∏—Ç–∏—á–Ω–æ: bloat >30% ‚Üí —Å—Ç–∞—Ç—É—Å `error`

**–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

```sql
SELECT 
  begin_time,
  status,
  info,
  errmsg
FROM upoa_ksk_reports.ksk_system_operations_log
WHERE operation_name LIKE '%bloat%'
ORDER BY begin_time DESC
LIMIT 10;
```


***

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ cron

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ crontab

```bash
crontab -e
```


### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á

```bash
# –ó–∞–¥–∞—á–∞ #1: ANALYZE –≤—á–µ—Ä–∞—à–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (00:30)
30 0 * * * psql -d ksk_database -U postgres -c "DO \$\$ DECLARE v_date TEXT := TO_CHAR(CURRENT_DATE - 1, 'YYYYMMDD'); BEGIN EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_result_' || v_date; EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_figurant_' || v_date; EXECUTE 'ANALYZE upoa_ksk_reports.part_ksk_match_' || v_date; END \$\$;"

# –ó–∞–¥–∞—á–∞ #2: –°–æ–∑–¥–∞–Ω–∏–µ –±—É–¥—É—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (01:00)
0 1 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_create_partitions_for_all_tables(CURRENT_DATE, 7);"

# –ó–∞–¥–∞—á–∞ #3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ (01:30)
30 1 * * * psql -d ksk_database -U postgres -c "DO \$\$ DECLARE rec RECORD; BEGIN FOR rec IN SELECT report_code FROM upoa_ksk_reports.ksk_report_orchestrator ORDER BY report_code LOOP PERFORM upoa_ksk_reports.ksk_run_report(rec.report_code, 'system'); END LOOP; END \$\$;"

# –ó–∞–¥–∞—á–∞ #4: –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ–¥–Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (02:00)
0 2 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_drop_old_partitions(365);"

# –ó–∞–¥–∞—á–∞ #5: –£–¥–∞–ª–µ–Ω–∏–µ empty –∑–∞–ø–∏—Å–µ–π (03:00)
0 3 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_cleanup_empty_records(14);"

# –ó–∞–¥–∞—á–∞ #6: –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (03:30)
30 3 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_cleanup_empty_partitions('all', 14);"

# –ó–∞–¥–∞—á–∞ #7: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ (04:00)
0 4 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_cleanup_old_reports();"

# –ó–∞–¥–∞—á–∞ #8: –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ (04:30)
30 4 * * * psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_cleanup_old_logs(365);"

# –ó–∞–¥–∞—á–∞ #9: VACUUM –≥–ª–∞–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (05:00)
0 5 * * * psql -d ksk_database -U postgres -c "VACUUM ANALYZE upoa_ksk_reports.ksk_result; VACUUM ANALYZE upoa_ksk_reports.ksk_figurant; VACUUM ANALYZE upoa_ksk_reports.ksk_match; VACUUM ANALYZE upoa_ksk_reports.ksk_report_header; VACUUM ANALYZE upoa_ksk_reports.ksk_system_operations_log;"

# –ó–∞–¥–∞—á–∞ #10: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bloat (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 04:00)
0 4 * * 0 psql -d ksk_database -U postgres -c "SELECT upoa_ksk_reports.ksk_monitor_table_bloat();"
```


***

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```sql
SELECT 
    begin_time,
    operation_name,
    status,
    info
FROM upoa_ksk_reports.ksk_system_operations_log
ORDER BY begin_time DESC
LIMIT 20;
```


### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

```sql
SELECT 
    begin_time,
    operation_name,
    status,
    info,
    errmsg
FROM upoa_ksk_reports.ksk_system_operations_log
WHERE status = 'error'
  AND begin_time > NOW() - INTERVAL '24 hours'
ORDER BY begin_time DESC;
```


### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –∑–∞ –º–µ—Å—è—Ü

```sql
SELECT 
    DATE(begin_time) AS log_date,
    COUNT(*) AS operations_count,
    SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) AS success_count,
    SUM(CASE WHEN status = 'error' THEN 1 ELSE 0 END) AS error_count
FROM upoa_ksk_reports.ksk_system_operations_log
WHERE begin_time > NOW() - INTERVAL '30 days'
GROUP BY DATE(begin_time)
ORDER BY log_date DESC;
```


***

## ‚ö†Ô∏è Troubleshooting

### –ó–∞–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PostgreSQL: `/var/log/postgresql/postgresql-*.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥ –ö–°–ö:

```sql
SELECT * FROM upoa_ksk_reports.ksk_system_operations_log 
WHERE status = 'error' 
ORDER BY begin_time DESC LIMIT 10;
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ cron –ª–æ–≥–∏: `grep CRON /var/log/syslog`

### –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
SELECT * FROM upoa_ksk_reports.ksk_list_partitions('ksk_result');

-- –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
SELECT upoa_ksk_reports.ksk_create_partitions('ksk_result', CURRENT_DATE, 7);
```


### VACUUM —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ bloat
SELECT 
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_pct
FROM pg_stat_user_tables
WHERE schemaname = 'upoa_ksk_reports'
ORDER BY dead_pct DESC;
```


### –û—Ç—á—ë—Ç—ã –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
SELECT * FROM upoa_ksk_reports.ksk_report_orchestrator;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç—á—ë—Ç–æ–≤
SELECT * FROM upoa_ksk_reports.ksk_report_header 
ORDER BY create_date DESC LIMIT 10;
```


***

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–ö–æ–º–∞–Ω–¥–∞:** –ö–°–ö Database Team
**Email:** ksk-db-support@example.com
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [Wiki –ø—Ä–æ–µ–∫—Ç–∞](https://wiki.example.com/ksk)

***

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–µ–∫—Ç ¬© 2025
<span style="display:none">[^1][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://www.postgresql.org/docs/current/maintenance.html

[^2]: https://opensource-db.com/essential-postgresql-maintenance-activities-for-optimal-performance/

[^3]: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL_pg_cron.html

[^4]: https://www.reddit.com/r/PostgreSQL/comments/x1jb6o/what_scheduled_maintenance_tasks_do_you_perform/

[^5]: https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-maintenance

[^6]: http://postgres-x2.github.io/reference/1.2/html/maintenance.html

[^7]: https://www.redwood.com/article/job-scheduling-with-postgres/

[^8]: https://visuresolutions.zendesk.com/hc/en-us/articles/4405371959187-Maintenance-of-PostgreSQL-Database-and-Automation

[^9]: https://stackoverflow.com/questions/37122803/manual-schedule-in-postgresql

