# План митапа: Архитектура системы отчетов КСК

**Продолжительность:** 60 минут  
**Целевая аудитория:** Технические специалисты, разработчики, архитекторы

---

## 1. Введение (5 минут)

### Цель системы
- Автоматизация формирования отчетов по транзакциям КСК
- Два типа отчетов: системные (ежедневные) и пользовательские (произвольный период)
- Поддержка различных срезов данных: статистика, списки, фигуранты, типы платежей

### Бизнес-контекст
- Отслеживание транзакций по резолюциям: Allow, Review, Deny
- Мониторинг bypass (пропущенных) транзакций
- Анализ работы по спискам и фигурантам

---

## 2. Архитектура данных (10 минут)

### Схема базы данных
**Схема:** `upoa_ksk_reports`

**Основные таблицы:**
- `ksk_report_header` - метаданные отчетов (дата, статус, тип, создан)
- `ksk_report_totals_data` - общая статистика
- `ksk_report_totals_by_payment_type_data` - статистика по типам платежей
- `ksk_report_list_totals_data` - итоги по спискам
- `ksk_report_list_totals_by_payment_type_data` - итоги по спискам и типам
- `ksk_report_figurants_data` - данные по фигурантам
- `ksk_report_review_data` - детальные данные проверок

### Типы платежей
- `i_*` - Входящий
- `o_*` - Исходящий
- `t_*` - Транзитный
- `m_*` - Межфилиальный
- `v_*` - Внутрифилиальный

---

## 3. Слой генерации отчетов (15 минут)

### SQL-функции генерации

**Системные отчеты (ежедневные):**
- `ksk_report_totals(p_report_date DATE)` - общая статистика
- `ksk_report_totals_by_payment_type(p_report_date DATE)` - по типам платежей
- `ksk_report_list_totals(p_report_date DATE)` - итоги по спискам
- `ksk_report_list_totals_by_payment_type(p_report_date DATE)` - списки × типы
- `ksk_report_figurants(p_report_date DATE)` - отчет по фигурантам
- `ksk_report_review(p_report_date DATE)` - детальный отчет проверок

**Пользовательские отчеты (произвольный период):**
- Те же функции с параметрами `p_start_date` и `p_end_date`

### Процесс генерации
1. Создание записи в `ksk_report_header` со статусом 'PENDING'
2. Вызов функции генерации данных
3. Заполнение соответствующей таблицы данных
4. Обновление статуса на 'DONE' или 'ERROR'

---

## 4. REST API (10 минут)

### Пользовательские отчеты

**Список отчетов:**
```
GET /api/reports/user
```

**Создание отчета:**
```
POST /api/reports/user
{
  "report_type": "totals",
  "start_date": "2025-10-01",
  "end_date": "2025-10-25"
}
```

**Получение данных:**
```
GET /api/reports/user/{report_id}/data?limit=100&offset=0
```

### Системные отчеты

**Навигация по датам:**
```
GET /api/reports/system/dates
GET /api/reports/system/dates/prev?date=2025-10-25
GET /api/reports/system/dates/next?date=2025-10-25
```

**Получение данных:**
```
GET /api/reports/system/totals/data?date=2025-10-25
GET /api/reports/system/totals_by_payment_type/data?date=2025-10-25
GET /api/reports/system/list_totals/data?date=2025-10-25&limit=100&offset=0
GET /api/reports/system/figurants/data?date=2025-10-25&limit=100&offset=0
GET /api/reports/system/review/data?date=2025-10-25&limit=100&offset=0
```

### Пагинация
- Применяется к детальным отчетам (списки, фигуранты, проверки)
- Параметры: `limit` (по умолчанию 100), `offset` (по умолчанию 0)
- Отчеты totals и totals_by_payment_type - без пагинации (1 строка на день)

---

## 5. Frontend архитектура (10 минут)

### Технологический стек
- SPA (Single Page Application)
- Нативный JavaScript (без фреймворков)
- CSS Grid/Flexbox для адаптивной верстки

### Структура UI

**Меню:**
```
- Главная
- Отчеты
  ├─ Мои отчеты
  └─ Системные
     ├─ Статистика
     ├─ По типам платежей
     ├─ Списки
     ├─ Списки по типам
     ├─ Фигуранты
     └─ Проверки
```

### Основные экраны
1. **Главная** - выбор типа отчетов
2. **Мои отчеты** - таблица с фильтрацией и статусами (Готов, В процессе, Ошибка)
3. **Создание отчета** - форма с выбором типа и периода
4. **Просмотр данных** - таблица с пагинацией/экспортом
5. **Системные отчеты** - навигация по датам + карточки типов
6. **Детальный просмотр** - статистика с визуализацией

### Компоненты визуализации
- Информационные карточки (дата, статус, тип отчета)
- Большие карточки с ключевыми метриками
- Резолюции с цветовым кодированием:
  - Allow (зеленая рамка)
  - Review (желтая рамка)
  - Deny (красная рамка)

---

## 6. Особенности реализации (5 минут)

### Партиционирование
- Таблицы партиционированы по дате отчета
- Автоматическое создание партиций для новых дат
- Оптимизация запросов через partition pruning

### Управление хранением
- Автоматическая очистка старых данных
- VACUUM для освобождения места
- Мониторинг размера партиций

### Обработка ошибок
- Логирование всех этапов генерации
- Статусы: PENDING, IN_PROGRESS, DONE, ERROR
- Возможность перезапуска неуспешных отчетов

---

## 7. Демонстрация (10 минут)

### Live demo
- Создание пользовательского отчета
- Навигация по системным отчетам
- Просмотр статистики с визуализацией
- Экспорт данных (XLSX, CSV, PDF)

---

## 8. Q&A (5 минут)

### Вопросы для обсуждения
- Масштабирование при росте объема данных
- Добавление новых типов отчетов
- Интеграция с другими системами
- Производительность и оптимизация

---

## Материалы для подготовки

### Файлы
- `ksk_reports_system.sql` - DDL схемы и функций генерации
- `ksk_spa_final.html` - рабочий прототип UI
- REST API спецификация (JSON примеры)

### Диаграммы
- Схема базы данных (ER-диаграмма)
- Архитектура API
- Последовательность генерации отчета (sequence diagram)

---

## Следующие шаги

1. Код-ревью SQL-функций
2. Автотесты для API
3. Нагрузочное тестирование
4. Документация для пользователей
5. План внедрения в production
