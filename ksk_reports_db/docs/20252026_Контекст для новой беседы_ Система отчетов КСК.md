
# Контекст для новой беседы: Система отчетов КСК

## Проект

Разрабатываем **систему отчетов КСК** (контроль санкционных клиентов) для банка. Система анализирует транзакции и формирует отчеты с различными срезами данных.

## Архитектура (кратко)

### База данных

- **СУБД:** PostgreSQL
- **Схема:** `upoa_ksk_reports`
- **Партиционирование:** по дате отчета
- **Основная таблица:** `ksk_report_header` (метаданные: дата, статус, тип, timestamp)
- **Таблицы данных:** 6 типов отчетов (totals, totals_by_payment_type, list_totals, list_totals_by_payment_type, figurants, review)


### Типы платежей (ВАЖНО!)

- `i_*` - Входящий
- `o_*` - Исходящий
- `t_*` - Транзитный
- `m_*` - Межфилиальный
- `v_*` - Внутрифилиальный


### Резолюции транзакций

- **Allow** (разрешено)
- **Review** (требует проверки)
- **Deny** (запрещено)
- **Bypass** (пропущено без проверки)


## Типы отчетов

### Системные (ежедневные, автоматические)

1. Статистика (totals)
2. Статистика по типам платежей (totals_by_payment_type)
3. Итоги по спискам (list_totals)
4. Итоги по спискам и типам платежей (list_totals_by_payment_type)
5. Отчёт по фигурантам (figurants)
6. Проверки - детальный отчет (review)

### Пользовательские

Те же 6 типов, но за произвольный период (start_date, end_date)

## REST API структура

### Пользовательские отчеты

- `GET /api/reports/user` - список
- `POST /api/reports/user` - создание
- `GET /api/reports/user/{id}/data` - получение данных (с пагинацией)


### Системные отчеты

- `GET /api/reports/system/dates` - список дат с отчетами
- `GET /api/reports/system/dates/prev?date=...` - предыдущая дата
- `GET /api/reports/system/dates/next?date=...` - следующая дата
- `GET /api/reports/system/{type}/data?date=...` - данные отчета

**Пагинация:** только для детальных отчетов (list_totals, figurants, review). Отчеты totals и totals_by_payment_type возвращают 1 строку на день.

## Frontend (SPA)

### Технологии

- Нативный JavaScript (без фреймворков)
- Single Page Application в одном HTML-файле
- 11 экранов с навигацией


### Структура меню

```
- Главная
- Отчеты
  ├─ Мои отчеты
  └─ Системные
     ├─ Статистика
     ├─ По типам платежей
     ├─ Списки
     ├─ Списки по типам
     ├─ Фигуранты
     └─ Проверки
```


### Ключевые особенности UI

1. **Комбобокс дат** с навигацией (кнопки ◀ Назад / Вперед ▶) во всех системных отчетах
2. **Информационная панель** для отчетов (дата, статус, создан, тип)
3. **Большие карточки** с метриками и детализацией
4. **Резолюции с цветными рамками:**
    - Allow - зеленая рамка слева
    - Review - желтая рамка слева
    - Deny - красная рамка слева
5. **Кнопки экспорта:** XLSX, CSV, PDF

## Статусы отчетов

- `PENDING` - в очереди
- `IN_PROGRESS` - генерируется
- `DONE` - готов
- `ERROR` - ошибка


## Что уже сделано

✅ Схема БД и SQL-функции генерации
✅ REST API спецификация с примерами JSON
✅ HTML-прототип (SPA с 11 экранами)
✅ План митапа по архитектуре

## Стиль общения

Рабочий, прямой, без лишних слов. Можно использовать мат редко и только когда уместно для эмоциональной окраски.

***

**Приложены файлы:** SQL-схема, REST API спецификация, HTML-прототип, план митапа.

