
# –û–±–Ω–æ–≤–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü, —Ñ—É–Ω–∫—Ü–∏—è–º –∏ –ø–µ—Ä–µ—á–∏—Ç–∞–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –Ω–∏–º.

–ù—É–∂–Ω–æ —á—Ç–æ–±—ã —Ç—ã –ø–æ–Ω–∏–º–∞–ª –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.

—Ñ—É–Ω–∫—Ü–∏—è put_ksk_result –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–º. Spring Java.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç –æ—Ç—á–µ—Ç—ã –≤ Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ. Backend –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ Spring Java —Å–µ—Ä–≤–∏—Å–µ –≤ –∫—É–±–µ—Ä.

–°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç put_ksk_result –∏ –±–∞–∫–µ–Ω–¥ - —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.
–°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç put_ksk_result —á–∏—Ç–∞–µ—Ç –¥–≤–∞ —Ç–æ–ø–∏–∫–∞ –∫–∞—Ñ–∫–∞ upoa_enriched_transactions –∏ upoa_ksk_results. –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–∑ –Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ corrId –∏ –≤—ã–∑—ã–≤–∞–µ—Ç put_ksk_result –ø–µ—Ä–µ–¥–∞–≤–∞—è —Ç–∞–∫ –∂–µ timestamp —Å–æ–æ–±—â–µ–Ω–∏–π.

–°–µ–π—á–∞—Å –Ω–∞–º –Ω–∞–¥–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–¥—É–º–∞—Ç—å. –í–æ–∑–º–æ–∂–Ω–æ –¥–∞—à–±–æ—Ä–¥—ã.
–¶–µ–ª—å - –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç.

–û—Ç–ª–∏—á–Ω–æ! –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω. –¢–µ–ø–µ—Ä—å —á—ë—Ç–∫–æ –ø–æ–Ω–∏–º–∞—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã –ö–°–ö.[^1][^2][^3][^4]

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ö–°–ö (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

**1. Kafka Consumer Service (Spring Java)**

- –ß–∏—Ç–∞–µ—Ç —Ç–æ–ø–∏–∫–∏: `upoa_enriched_transactions` + `upoa_ksk_results`
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ `corrId`
- –í—ã–∑—ã–≤–∞–µ—Ç `put_ksk_result()` —Å timestamps –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫

**2. PostgreSQL Database**

- –°—Ö–µ–º–∞: `upoa_ksk_reports`
- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: `ksk_result` (3M –∑–∞–ø–∏—Å–µ–π/–¥–µ–Ω—å), `ksk_figurant`, `ksk_match`
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º (`output_timestamp`)
- 3TB –¥–∞–Ω–Ω—ã—Ö, HDD —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

**3. Web Backend Service (Spring Java, Kubernetes)**

- –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç Kafka Consumer
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç—ã —á–µ—Ä–µ–∑ `ksk_run_report()`
- –ß–∏—Ç–∞–µ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü –æ—Ç—á—ë—Ç–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

**4. Reporting System**

- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤: `ksk_report_orchestrator`
- 5 —Ç–∏–ø–æ–≤ –æ—Ç—á—ë—Ç–æ–≤: totals, list_totals, –ø–æ —Ç–∏–ø–∞–º –ø–ª–∞—Ç–µ–∂–µ–π, –ø–æ —Ñ–∏–≥—É—Ä–∞–Ω—Ç–∞–º
- TTL: —Å–∏—Å—Ç–µ–º–Ω—ã–µ (365 –¥–Ω–µ–π), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ (7-14 –¥–Ω–µ–π)

***

## üìä –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ö–°–ö

–†–∞–∑—Ä–∞–±–æ—Ç–∞—é **—Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é** —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

### –£—Ä–æ–≤–µ–Ω—å 1: Kafka Consumer Service (Java-–º–µ—Ç—Ä–∏–∫–∏)

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**


| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ù–æ—Ä–º–∞ | –ê–ª–µ—Ä—Ç |
| :-- | :-- | :-- | :-- |
| `ksk.kafka.lag` | –õ–∞–≥ –ø–æ —Ç–æ–ø–∏–∫–∞–º Kafka | <10,000 | >50,000 |
| `ksk.kafka.messages.rate` | –°–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ | 30-50/sec | <10/sec |
| `ksk.kafka.join.success_rate` | % —É—Å–ø–µ—à–Ω—ã—Ö join –ø–æ corrId | >98% | <95% |
| `ksk.kafka.join.delay_avg` | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–∞—Ä—ã | <2 sec | >10 sec |
| `ksk.db.put_result.duration_p95` | p95 –≤—Ä–µ–º–µ–Ω–∏ `put_ksk_result()` | <100ms | >200ms |
| `ksk.db.put_result.errors_rate` | –û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î | 0 | >1% |
| `ksk.kafka.orphan_messages` | –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–∞—Ä—ã >5 –º–∏–Ω | 0 | >100 |

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è (Micrometer + Prometheus):**

```java
@Service
public class KskConsumerMetrics {
    
    private final MeterRegistry registry;
    private final Counter messagesProcessed;
    private final Counter joinSuccesses;
    private final Counter joinFailures;
    private final Gauge kafkaLag;
    private final Timer putResultTimer;
    
    @Autowired
    public KskConsumerMetrics(MeterRegistry registry, KafkaConsumer consumer) {
        this.registry = registry;
        
        // –°—á—ë—Ç—á–∏–∫–∏
        this.messagesProcessed = Counter.builder("ksk.kafka.messages.processed")
            .tag("topic", "all")
            .description("Total messages processed from Kafka")
            .register(registry);
            
        this.joinSuccesses = Counter.builder("ksk.kafka.join.success")
            .description("Successful corrId joins")
            .register(registry);
            
        this.joinFailures = Counter.builder("ksk.kafka.join.failure")
            .description("Failed corrId joins (timeout/missing)")
            .register(registry);
            
        // Gauge –¥–ª—è –ª–∞–≥–∞
        this.kafkaLag = Gauge.builder("ksk.kafka.lag", consumer, c -> c.getCurrentLag())
            .tag("topic", "upoa_enriched_transactions")
            .description("Kafka consumer lag")
            .register(registry);
            
        // –¢–∞–π–º–µ—Ä –¥–ª—è put_ksk_result
        this.putResultTimer = Timer.builder("ksk.db.put_result.duration")
            .description("Duration of put_ksk_result() calls")
            .publishPercentiles(0.5, 0.95, 0.99)
            .register(registry);
    }
    
    public void recordPutResult(Runnable dbCall) {
        putResultTimer.record(dbCall);
    }
}
```


***

### –£—Ä–æ–≤–µ–Ω—å 2: Database Metrics (PostgreSQL + SQL)

**SQL view –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```sql
-- ============================================================================
-- VIEW: ksk_monitoring_health
-- –°–≤–æ–¥–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
-- ============================================================================
CREATE OR REPLACE VIEW upoa_ksk_reports.ksk_monitoring_health AS
SELECT
    -- –í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
    NOW() - INTERVAL '5 minutes' AS period_start,
    NOW() AS period_end,
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
    (SELECT COUNT(*) 
     FROM upoa_ksk_reports.ksk_result 
     WHERE output_timestamp > NOW() - INTERVAL '5 minutes') AS records_last_5min,
     
    (SELECT COUNT(*) 
     FROM upoa_ksk_reports.ksk_result 
     WHERE output_timestamp > NOW() - INTERVAL '5 minutes') / 300.0 AS records_per_second,
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç—á—ë—Ç–æ–≤
    (SELECT COUNT(*) 
     FROM upoa_ksk_reports.ksk_report_header 
     WHERE created_datetime > NOW() - INTERVAL '24 hours'
       AND status = 'done') AS reports_generated_24h,
       
    (SELECT COUNT(*) 
     FROM upoa_ksk_reports.ksk_report_header 
     WHERE status = 'error'
       AND created_datetime > NOW() - INTERVAL '1 hour') AS report_errors_1h,
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    (SELECT COUNT(*) 
     FROM upoa_ksk_reports.ksk_system_operations_log 
     WHERE status = 'error'
       AND begin_time > NOW() - INTERVAL '24 hours') AS maintenance_errors_24h,
    
    -- –û–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö
    (SELECT COUNT(*) FROM upoa_ksk_reports.ksk_result) AS total_records,
    
    -- –ü–∞—Ä—Ç–∏—Ü–∏–∏
    (SELECT COUNT(*) 
     FROM pg_tables 
     WHERE schemaname = 'upoa_ksk_reports' 
       AND tablename LIKE 'part_ksk_result_%') AS partition_count,
    
    -- –†–∞–∑–º–µ—Ä –ë–î
    pg_size_pretty(pg_database_size(current_database())) AS db_size;

COMMENT ON VIEW upoa_ksk_reports.ksk_monitoring_health IS
'–°–≤–æ–¥–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã –ö–°–ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç';
```

**SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```sql
CREATE OR REPLACE FUNCTION upoa_ksk_reports.ksk_get_monitoring_stats(
    p_period_minutes INTEGER DEFAULT 5
)
RETURNS TABLE (
    metric_name VARCHAR(100),
    metric_value NUMERIC,
    metric_status VARCHAR(20),
    metric_description TEXT
) 
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    WITH metrics AS (
        SELECT 
            'records_rate' AS name,
            (SELECT COUNT(*)::NUMERIC 
             FROM upoa_ksk_reports.ksk_result 
             WHERE output_timestamp > NOW() - (p_period_minutes || ' minutes')::INTERVAL
            ) / p_period_minutes / 60.0 AS value,
            '–ó–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—É–Ω–¥—É' AS description,
            CASE 
                WHEN (SELECT COUNT(*) FROM upoa_ksk_reports.ksk_result 
                      WHERE output_timestamp > NOW() - (p_period_minutes || ' minutes')::INTERVAL
                     ) / p_period_minutes / 60.0 > 30 THEN 'OK'
                WHEN (SELECT COUNT(*) FROM upoa_ksk_reports.ksk_result 
                      WHERE output_timestamp > NOW() - (p_period_minutes || ' minutes')::INTERVAL
                     ) / p_period_minutes / 60.0 > 10 THEN 'WARNING'
                ELSE 'CRITICAL'
            END AS status
            
        UNION ALL
        
        SELECT 
            'partition_lag' AS name,
            EXTRACT(EPOCH FROM (NOW() - MAX(output_timestamp)))::NUMERIC / 60 AS value,
            '–ú–∏–Ω—É—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏' AS description,
            CASE 
                WHEN EXTRACT(EPOCH FROM (NOW() - MAX(output_timestamp))) < 300 THEN 'OK'
                WHEN EXTRACT(EPOCH FROM (NOW() - MAX(output_timestamp))) < 600 THEN 'WARNING'
                ELSE 'CRITICAL'
            END AS status
        FROM upoa_ksk_reports.ksk_result
        
        UNION ALL
        
        SELECT 
            'report_errors' AS name,
            COUNT(*)::NUMERIC AS value,
            '–û—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ (1 —á–∞—Å)' AS description,
            CASE 
                WHEN COUNT(*) = 0 THEN 'OK'
                WHEN COUNT(*) < 5 THEN 'WARNING'
                ELSE 'CRITICAL'
            END AS status
        FROM upoa_ksk_reports.ksk_report_header
        WHERE status = 'error'
          AND created_datetime > NOW() - INTERVAL '1 hour'
    )
    SELECT name, value, status, description
    FROM metrics;
END;
$$;
```


***

### –£—Ä–æ–≤–µ–Ω—å 3: Grafana Dashboards

**Dashboard 1: KSK Operations Overview**

**–ü–∞–Ω–µ–ª–∏:**

1. **Kafka Throughput** (Graph)
    - `rate(ksk_kafka_messages_processed_total[5m])`
    - –¶–µ–ª–µ–≤–∞—è –ª–∏–Ω–∏—è: 30-50 msg/sec
2. **Database Write Performance** (Graph)
    - `histogram_quantile(0.95, ksk_db_put_result_duration_seconds_bucket)`
    - –¶–µ–ª–µ–≤–∞—è –ª–∏–Ω–∏—è: <100ms
3. **Kafka Lag** (Gauge)
    - `ksk_kafka_lag{topic="upoa_enriched_transactions"}`
    - –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞: >50,000
4. **Join Success Rate** (Stat)
    - `(ksk_kafka_join_success_total / (ksk_kafka_join_success_total + ksk_kafka_join_failure_total)) * 100`
    - –¶–µ–ª–µ–≤–æ–µ: >98%
5. **Records per Second** (Graph + Stat)
    - SQL: `SELECT * FROM ksk_monitoring_health`
    - –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å: `records_per_second`
6. **Database Size Growth** (Graph)
    - `pg_database_size{datname="ksk_database"}`
    - –¢—Ä–µ–Ω–¥ —Ä–æ—Å—Ç–∞ –∑–∞ –Ω–µ–¥–µ–ª—é

**Dashboard 2: KSK Reports Health**

**–ü–∞–Ω–µ–ª–∏:**

1. **Report Generation Time** (Heatmap)
    - SQL: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º –æ—Ç—á—ë—Ç–æ–≤
2. **Report Status Distribution** (Pie Chart)
    - done / in_progress / error
3. **Top Slowest Reports** (Table)
    - SQL: TOP-10 –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –∑–∞ —Å—É—Ç–∫–∏
4. **Report Errors Log** (Table)
    - SQL: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –æ—à–∏–±–æ–∫ –∏–∑ `ksk_report_header`

**Dashboard 3: KSK Maintenance**

**–ü–∞–Ω–µ–ª–∏:**

1. **Daily Maintenance Tasks Status** (Timeline)
    - SQL: —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á –∏–∑ `ksk_system_operations_log`
2. **Partition Count** (Stat)
    - –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π
3. **Table Bloat** (Bar Gauge)
    - –ü—Ä–æ—Ü–µ–Ω—Ç bloat –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
4. **Disk Space Trend** (Graph)
    - –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞

***

## üö® Alerting Rules (Prometheus Alertmanager)

```yaml
groups:
  - name: ksk_critical
    interval: 30s
    rules:
      # –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
      - alert: KSKKafkaLagCritical
        expr: ksk_kafka_lag > 50000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–∞–≥ Kafka –≤ –ö–°–ö"
          description: "–õ–∞–≥ {{ $value }} —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–æ—Ä–º–∞ <10,000)"
          
      - alert: KSKDatabaseWriteSlow
        expr: histogram_quantile(0.95, ksk_db_put_result_duration_seconds_bucket) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "–ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î –ö–°–ö"
          description: "p95 –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏: {{ $value }}s (–Ω–æ—Ä–º–∞ <0.1s)"
          
      - alert: KSKNoDataIngestion
        expr: rate(ksk_kafka_messages_processed_total[5m]) < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –ö–°–ö"
          description: "–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏: {{ $value }} msg/sec (–Ω–æ—Ä–º–∞ 30-50)"
          
      - alert: KSKReportGenerationFailed
        expr: sum(ksk_report_errors_1h) > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ –ö–°–ö"
          description: "{{ $value }} –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å"
```


***

## üìã Runbook –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –∞–ª–µ—Ä—Ç–∞—Ö:**

### Alert: KSKKafkaLagCritical

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Kafka Consumer:

```bash
kubectl logs -n ksk deployment/ksk-consumer --tail=100
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL load:

```sql
SELECT * FROM pg_stat_activity WHERE state = 'active';
```

3. –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º consumer (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

### Alert: KSKDatabaseWriteSlow

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```sql
SELECT pid, now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - query_start > INTERVAL '1 minute';
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å bloat:

```sql
SELECT * FROM upoa_ksk_reports.ksk_monitor_table_bloat();
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å VACUUM –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ bloat >30%)

***

–ù—É–∂–Ω–∞ –ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–∫–æ–º—É-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –±–ª–æ–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞?
<span style="display:none">[^5][^6][^7][^8][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://readme.md

[^2]: https://www.postgresql.org/docs/current/maintenance.html

[^3]: https://opensource-db.com/essential-postgresql-maintenance-activities-for-optimal-performance/

[^4]: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL_pg_cron.html

[^5]: 001_ksk_result.sql

[^6]: 001_report_tables.sql

[^7]: 001_ksk_report_orchestrator.sql

[^8]: 004_ksk_system_operation_log.sql

[^9]: put_ksk_result_OPTIMIZED.sql

